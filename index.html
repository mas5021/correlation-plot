<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>US Agricultural Analysis: CO₂ vs Crop Production</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f8f9fa;
      margin: 2rem;
      text-align: center;
    }
    h1 { color: #2c3e50; margin-bottom: 0.5rem; }
    #chart { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .tooltip {
      position: absolute; 
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 0.8rem;
      border-radius: 4px;
      pointer-events: none;
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .trendline { stroke: #e74c3c; stroke-width: 2; stroke-dasharray: 4 2; }
    .data-point:hover { stroke: #e67e22; stroke-width: 2px; }
    #loading {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white; padding: 1rem 2rem;
      border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .error-message { color: red; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>US Agricultural Analysis: CO₂ vs Crop Production</h1>
  <svg id="chart" width="1000" height="600"></svg>
  <div id="tooltip" class="tooltip"></div>
  <div id="loading">Loading agricultural data...</div>
  <div class="error-message" id="errorBox"></div>

  <script>
    // Gist URLs for CSV files (adjust if needed).
    const CROP_CSV_URL = "https://gist.githubusercontent.com/mystrycodes/3d3cf36c88a4f23a187cb4e12a835e10/raw/CropProduction.csv";
    const CO2_CSV_URL  = "https://gist.githubusercontent.com/mystrycodes/f3e133db6c35f1f7180296e872441fe4/raw/Co2emmission.csv";

    // Basic margin, width, height
    const margin = { top: 60, right: 80, bottom: 90, left: 100 };
    const width = 1000 - margin.left - margin.right;
    const height = 600 - margin.top - margin.bottom;

    // Append group container to the SVG
    const svg = d3.select("#chart")
      .append("g")
      .attr("transform", `translate(${margin.left}, ${margin.top})`);

    let xScale, yScale;
    let zoomBehavior;
    let mergedData = [];

    // 1) Load CSVs individually so we can see partial success/failure.
    let cropData = null;
    let co2Data  = null;

    // Load Crop CSV
    d3.csv(CROP_CSV_URL).then(data => {
      console.log("Crop CSV loaded successfully:", data.length, "rows");
      cropData = cleanCropData(data);
      checkIfBothLoaded();
    }).catch(err => {
      console.error("Crop CSV load failed:", err);
      document.getElementById("errorBox").innerText += "\n⚠️ Crop CSV failed to load.";
      checkIfBothLoaded();
    });

    // Load CO2 CSV
    d3.csv(CO2_CSV_URL).then(data => {
      console.log("CO2 CSV loaded successfully:", data.length, "rows");
      co2Data = cleanCO2Data(data);
      checkIfBothLoaded();
    }).catch(err => {
      console.error("CO2 CSV load failed:", err);
      document.getElementById("errorBox").innerText += "\n⚠️ CO2 CSV failed to load.";
      checkIfBothLoaded();
    });

    // 2) Check if both datasets are loaded or have errors
    function checkIfBothLoaded() {
      if (cropData === null || co2Data === null) {
        // Means at least one dataset isn't loaded yet or failed.
        return;
      }
      // Both are loaded or have partial data. Proceed to merge if both are arrays.
      if (!Array.isArray(cropData) || !Array.isArray(co2Data)) {
        showError("One dataset is invalid. Check console for details.");
        return;
      }
      // Attempt merging
      mergeAndVisualize();
    }

    // 3) Clean Crop Data
    function cleanCropData(raw) {
      // Crop CSV columns: index,Country,INDICATOR,SUBJECT,MEASURE,FREQUENCY,TIME,Value,Flag Codes
      // Use TIME as year, Value as production
      // Filter for "United States"
      const filtered = raw.filter(d => d.Country && d.Country.includes("United States"));
      console.log("Filtered Crop Data (US):", filtered.length, "rows");
      return filtered.map(d => ({
        year: +d.TIME,
        production: +d.Value,
        country: d.Country
      })).filter(d => !isNaN(d.year) && !isNaN(d.production));
    }

    // 4) Clean CO₂ Data
    function cleanCO2Data(raw) {
      // CO₂ CSV columns: Country,Year,Savanna fires,Forest fires,...,total_emission,...
      // Use total_emission as CO2
      // Filter for "United States"
      const filtered = raw.filter(d => d.Country && d.Country.includes("United States"));
      console.log("Filtered CO2 Data (US):", filtered.length, "rows");
      return filtered.map(d => ({
        year: +d.Year,
        co2: +d.total_emission,
        country: d.Country
      })).filter(d => !isNaN(d.year) && !isNaN(d.co2));
    }

    // 5) Merge Datasets by year
    function mergeAndVisualize() {
      const commonYears = findCommonYears(cropData, co2Data);
      console.log("Common Years:", commonYears);
      if (commonYears.length === 0) {
        showError("No overlapping data available - check data sources");
        return;
      }
      mergedData = commonYears.map(year => ({
        year,
        production: cropData.find(c => c.year === year).production,
        co2: co2Data.find(c => c.year === year).co2
      }));
      console.log("Merged Data:", mergedData);

      if (mergedData.length === 0) {
        showError("Merged data is empty. No overlapping years found.");
        return;
      }
      document.getElementById("loading").remove();
      initializeVisualization();
    }

    // 6) Find Common Years
    function findCommonYears(crop, co2) {
      const cropYears = new Set(crop.map(d => d.year));
      return [...new Set(co2.map(d => d.year))]
        .filter(y => cropYears.has(y))
        .sort((a, b) => a - b);
    }

    // 7) Visualization
    function initializeVisualization() {
      xScale = d3.scaleLinear()
        .domain(d3.extent(mergedData, d => d.co2))
        .range([0, width])
        .nice();

      yScale = d3.scaleLinear()
        .domain(d3.extent(mergedData, d => d.production))
        .range([height, 0])
        .nice();

      zoomBehavior = d3.zoom()
        .scaleExtent([1, 8])
        .on('zoom', handleZoom);

      d3.select('#chart').call(zoomBehavior);

      drawPoints();
      addTrendline();
      addAxes();
    }

    function drawPoints() {
      svg.selectAll(".data-point")
        .data(mergedData)
        .enter()
        .append("circle")
        .attr("class", "data-point")
        .attr("cx", d => xScale(d.co2))
        .attr("cy", d => yScale(d.production))
        .attr("r", 6)
        .attr("fill", "#3498db")
        .attr("stroke", "#fff")
        .attr("stroke-width", 1)
        .on("mouseover", showTooltip)
        .on("mouseout", hideTooltip);
    }

    function addAxes() {
      svg.append("g")
        .attr("class", "x-axis")
        .attr("transform", `translate(0, ${height})`)
        .call(d3.axisBottom(xScale).tickFormat(d => `${(d/1e6).toFixed(1)}M t`));

      svg.append("text")
        .attr("x", width/2)
        .attr("y", height + margin.bottom - 10)
        .style("text-anchor", "middle")
        .text("CO₂ Emissions (Million Metric Tons)");

      svg.append("g")
        .attr("class", "y-axis")
        .call(d3.axisLeft(yScale).tickFormat(d => `${(d/1e3).toFixed(0)}k t`));

      svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", -margin.left + 20)
        .attr("x", -height/2)
        .style("text-anchor", "middle")
        .text("Crop Production (Thousand Tons)");
    }

    function addTrendline() {
      const lr = linearRegression(mergedData);
      const xExt = d3.extent(mergedData, d => d.co2);
      const trendData = xExt.map(xVal => ({
        x: xVal,
        y: lr.slope * xVal + lr.intercept
      }));
      svg.append("line")
        .attr("class", "trendline")
        .attr("x1", xScale(trendData[0].x))
        .attr("y1", yScale(trendData[0].y))
        .attr("x2", xScale(trendData[1].x))
        .attr("y2", yScale(trendData[1].y))
        .attr("stroke", "#e74c3c")
        .attr("stroke-width", 2)
        .attr("stroke-dasharray", "4,2");
    }

    function handleZoom(event) {
      const newX = event.transform.rescaleX(xScale);
      const newY = event.transform.rescaleY(yScale);

      svg.selectAll(".data-point")
        .attr("cx", d => newX(d.co2))
        .attr("cy", d => newY(d.production));

      svg.select(".x-axis").call(d3.axisBottom(newX).tickFormat(d => `${(d/1e6).toFixed(1)}M t`));
      svg.select(".y-axis").call(d3.axisLeft(newY).tickFormat(d => `${(d/1e3).toFixed(0)}k t`));
    }

    // Reset Zoom
    function resetZoom() {
      d3.select("#chart").transition()
        .duration(300)
        .call(zoomBehavior.transform, d3.zoomIdentity);
    }

    // Tooltip handlers
    function showTooltip(event, d) {
      d3.select('#tooltip')
        .style('opacity', 1)
        .style('left', `${event.pageX + 15}px`)
        .style('top', `${event.pageY - 30}px`)
        .html(`
          <div>Year: ${d.year}</div>
          <div>CO₂: ${(d.co2/1e6).toFixed(1)}M t</div>
          <div>Production: ${(d.production/1e3).toFixed(0)}k t</div>
        `);
    }
    function hideTooltip() {
      d3.select('#tooltip').style('opacity', 0);
    }

    // Show error message in #errorBox
    function showError(msg) {
      document.getElementById("errorBox").innerText = msg;
    }

    // If .catch triggers
    function handleLoadingError(error) {
      console.error("Data loading error:", error);
      document.getElementById("errorBox").innerText = "⚠️ Error loading data. Please check your connection or CSV URLs.";
    }

    // Simple linear regression
    function linearRegression(data) {
      const n = data.length;
      let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
      data.forEach(d => {
        sumX += d.co2;
        sumY += d.production;
        sumXY += d.co2 * d.production;
        sumXX += d.co2 * d.co2;
      });
      const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      return { slope, intercept };
    }
  </script>
</body>
</html>
