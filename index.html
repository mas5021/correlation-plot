<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>US Agricultural Analysis: CO₂ vs Crop Production</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f8f9fa;
      margin: 2rem;
      text-align: center;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }
    #dataInfo {
      color: #7f8c8d;
      margin-bottom: 1.5rem;
    }
    #controls {
      margin: 1.5rem 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
    }
    #yearSlider {
      width: 300px;
    }
    #chart {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 0.8rem;
      border-radius: 4px;
      pointer-events: none;
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .trendline {
      stroke: #e74c3c;
      stroke-width: 2;
      stroke-dasharray: 4 2;
    }
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>US Agricultural Analysis: CO₂ vs Crop Production</h1>
  <div id="dataInfo"></div>
  <div id="controls">
    <label for="yearSlider">Analysis Start Year:</label>
    <input type="range" id="yearSlider" min="0" max="0" step="1">
    <span id="currentYear" style="font-weight: bold; color: #2980b9;"></span>
  </div>
  <svg id="chart" width="1000" height="600"></svg>
  <div id="tooltip" class="tooltip"></div>
  <div id="loading">Loading agricultural data...</div>

  <script>
    // Configuration
    const DATA_URLS = {
      crop: 'https://gist.githubusercontent.com/mystrycodes/3d3cf36c88a4f23a187cb4e12a835e10/raw/CropProduction.csv',
      co2: 'https://gist.githubusercontent.com/mystrycodes/f3e133db6c35f1f7180296e872441fe4/raw/Co2emmission.csv'
    };

    // Visualization setup
    const svg = d3.select('#chart');
    const margin = { top: 60, right: 80, bottom: 90, left: 100 };
    const width = 1000 - margin.left - margin.right;
    const height = 600 - margin.top - margin.bottom;
    const chart = svg.append('g').attr('transform', `translate(${margin.left}, ${margin.top})`);

    // State management
    let analysisData = [];
    let yearRange = { min: 0, max: 0 };

    // Initialize visualization
    Promise.all([d3.csv(DATA_URLS.crop), d3.csv(DATA_URLS.co2)])
      .then(processDatasets)
      .catch(handleLoadingError);

    // Data processing pipeline
    function processDatasets([rawCrop, rawCO2]) {
      // Validate and clean datasets
      const cropData = cleanDataset(rawCrop, 'Production');
      const co2Data = cleanDataset(rawCO2, 'CO2', 'total_emission');
      
      // Find common year range
      const commonYears = findCommonYears(cropData, co2Data);
      if (commonYears.length === 0) {
        showErrorMessage('No overlapping data between CO₂ and crop datasets');
        return;
      }

      // Merge datasets
      analysisData = mergeDatasets(cropData, co2Data, commonYears);
      initializeControls(commonYears);
      updateVisualization(commonYears[0]);
    }

    function cleanDataset(data, valueField, co2Field = null) {
      return data
        .filter(d => d.Country === 'United States')
        .map(d => ({
          year: validateYear(d.Year),
          value: parseFloat(co2Field ? d[co2Field] : d[valueField]),
          country: d.Country
        }))
        .filter(d => d.year && !isNaN(d.value));
    }

    function validateYear(year) {
      const y = parseInt(year);
      return y >= 1990 && y <= 2023 ? y : null;
    }

    function findCommonYears(crop, co2) {
      const cropYears = new Set(crop.map(d => d.year));
      return [...new Set(co2.map(d => d.year))]
        .filter(year => cropYears.has(year))
        .sort((a, b) => a - b);
    }

    function mergeDatasets(crop, co2, years) {
      return years.map(year => {
        const cropEntry = crop.find(d => d.year === year);
        const co2Entry = co2.find(d => d.year === year);
        return {
          year,
          production: cropEntry.value,
          co2: co2Entry.value
        };
      });
    }

    // Visualization functions
    function initializeControls(years) {
      yearRange = { min: Math.min(...years), max: Math.max(...years) };
      
      d3.select('#yearSlider')
        .attr('min', yearRange.min)
        .attr('max', yearRange.max)
        .attr('value', yearRange.min)
        .on('input', function() {
          const selectedYear = +this.value;
          d3.select('#currentYear').text(selectedYear);
          updateVisualization(selectedYear);
        });

      d3.select('#dataInfo')
        .html(`<strong>Data Range:</strong> ${yearRange.min} - ${yearRange.max}<br>
              <em>All values normalized to US agricultural metrics</em>`);

      d3.select('#currentYear').text(yearRange.min);
      d3.select('#loading').style('display', 'none');
    }

    function updateVisualization(startYear) {
      const filteredData = analysisData.filter(d => d.year >= startYear);
      chart.selectAll('*').remove();

      if (filteredData.length < 2) {
        displayDataMessage(filteredData.length === 0 
          ? 'No data available for selected range'
          : 'Select at least two years for analysis');
        return;
      }

      // Create scales
      const xScale = d3.scaleLinear()
        .domain(d3.extent(filteredData, d => d.co2))
        .range([0, width])
        .nice();

      const yScale = d3.scaleLinear()
        .domain(d3.extent(filteredData, d => d.production))
        .range([height, 0])
        .nice();

      // Create axes
      const xAxis = d3.axisBottom(xScale)
        .tickFormat(d => `${d}M t`);
      const yAxis = d3.axisLeft(yScale)
        .tickFormat(d => `${d}k t`);

      chart.append('g')
        .attr('transform', `translate(0, ${height})`)
        .call(xAxis)
        .append('text')
        .attr('x', width / 2)
        .attr('y', 40)
        .attr('fill', '#2c3e50')
        .text('CO₂ Emissions (Million Metric Tons)');

      chart.append('g')
        .call(yAxis)
        .append('text')
        .attr('transform', 'rotate(-90)')
        .attr('y', -60)
        .attr('x', -height / 2)
        .attr('fill', '#2c3e50')
        .text('Crop Production (Thousand Tons)');

      // Draw data points
      chart.selectAll('.data-point')
        .data(filteredData)
        .enter()
        .append('circle')
        .attr('class', 'data-point')
        .attr('cx', d => xScale(d.co2))
        .attr('cy', d => yScale(d.production))
        .attr('r', 7)
        .attr('fill', '#3498db')
        .attr('stroke', '#fff')
        .attr('stroke-width', 1)
        .on('mouseover', showTooltip)
        .on('mouseout', hideTooltip);

      // Add trendline
      if (filteredData.length >= 2) {
        const trend = calculateTrend(filteredData);
        chart.append('line')
          .attr('class', 'trendline')
          .attr('x1', xScale(trend.xMin))
          .attr('y1', yScale(trend.yMin))
          .attr('x2', xScale(trend.xMax))
          .attr('y2', yScale(trend.yMax));
      }
    }

    function calculateTrend(data) {
      const xExtent = d3.extent(data, d => d.co2);
      const lr = d3.regressionLinear()
        .x(d => d.co2)
        .y(d => d.production)
        (data);
      return {
        xMin: xExtent[0],
        yMin: lr[0][1],
        xMax: xExtent[1],
        yMax: lr[1][1]
      };
    }

    // Interaction handlers
    function showTooltip(event, d) {
      d3.select('#tooltip')
        .style('opacity', 1)
        .style('left', `${event.pageX + 15}px`)
        .style('top', `${event.pageY - 30}px`)
        .html(`
          <div class="tooltip-year">${d.year}</div>
          <div>CO₂: ${d.co2.toLocaleString()}M tons</div>
          <div>Production: ${d.production.toLocaleString()}k tons</div>
        `);
    }

    function hideTooltip() {
      d3.select('#tooltip').style('opacity', 0);
    }

    // Error handling
    function handleLoadingError(error) {
      console.error('Data loading error:', error);
      d3.select('#loading')
        .html('<div class="error">⚠️ Error loading data. Please try refreshing the page.</div>');
    }

    function displayDataMessage(message) {
      chart.append('text')
        .attr('x', width / 2)
        .attr('y', height / 2)
        .attr('text-anchor', 'middle')
        .attr('fill', '#7f8c8d')
        .text(message);
    }
  </script>
</body>
</html>
