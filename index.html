<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>US Crop Yield vs. Solar Irradiance</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f8f9fa;
      margin: 2rem;
      text-align: center;
    }
    h1 { color: #2c3e50; }
    p { color: #7f8c8d; }
    #dropdown { margin-bottom: 20px; }
    .chart-container { width: 800px; margin: auto; }
    svg { border: 1px solid #ccc; }
    .tooltip { 
      position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem;
      border-radius: 4px; pointer-events: none; font-size: 0.9rem; opacity: 0; 
    }
  </style>
</head>
<body>
  <h1>US Crop Yield vs. Solar Irradiance</h1>
  <p>Interactive Dual-Axis Chart for a Selected Crop</p>
  <div id="dropdown">
    <label for="cropSelect">Select Crop: </label>
    <select id="cropSelect"></select>
  </div>
  <div class="chart-container">
    <svg id="chart" width="800" height="500"></svg>
  </div>
  <div id="tooltip" class="tooltip"></div>
  
  <script>
    // Define dataset URLs.
    const cropUrl = "https://gist.githubusercontent.com/mystrycodes/3d3cf36c88a4f23a187cb4e12a835e10/raw/5aebb1fc334be000f4b756db6d5c83adf71e89ab/CropProduction.csv";
    const climateUrl = "https://gist.githubusercontent.com/mystrycodes/0e4190865121859997eec1fc2d5b4dcd/raw/d10453ccf854feb48e10319eb8025a973f938abe/climate.csv";

    // Set margins and dimensions.
    const margin = { top: 60, right: 60, bottom: 60, left: 60 },
          width = 800 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

    // Create the SVG and a group container for chart elements.
    const svg = d3.select("#chart")
                  .append("g")
                  .attr("class", "gChart")
                  .attr("transform", `translate(${margin.left},${margin.top})`);

    const tooltip = d3.select("#tooltip");

    // Global variables to store processed data.
    let cropDataGrouped;    // Map: Crop => Array of {Year, Production}
    let climateDataGrouped; // Array of {Year, Solar}
    
    // Load both datasets concurrently.
    Promise.all([ d3.csv(cropUrl), d3.csv(climateUrl) ])
      .then(function([cropRaw, climateRaw]) {
        // --------------------------
        // PROCESS CROP PRODUCTION DATA:
        // --------------------------
        // Crop CSV columns: index, Country, INDICATOR, SUBJECT, MEASURE, FREQUENCY, TIME, Value, Flag Codes
        cropRaw.forEach(d => {
          // Use TIME field as year if Year is not present.
          d.Year = d.Year ? +d.Year : +d.TIME;
          d.Production = +d.Value;
          d.Crop = d.SUBJECT;
        });
        // Filter crop data for US – allow if Country contains "United States"
        const cropUSA = cropRaw.filter(d => d.Country && d.Country.includes("United States") && !isNaN(d.Year) && !isNaN(d.Production));
        console.log("Crop USA Data:", cropUSA);

        // Group crop data by Crop.
        cropDataGrouped = d3.group(cropUSA, d => d.Crop);
        // For each crop, group by Year and compute average Production.
        cropDataGrouped.forEach((values, cropName) => {
          const groupedByYear = d3.rollup(values, v => d3.mean(v, d => d.Production), d => d.Year);
          const arr = Array.from(groupedByYear, ([Year, Production]) => ({ Year, Production }));
          arr.sort((a, b) => a.Year - b.Year);
          cropDataGrouped.set(cropName, arr);
        });
        console.log("Grouped Crop Data:", cropDataGrouped);

        // --------------------------
        // PROCESS CLIMATE DATA:
        // --------------------------
        // Climate CSV columns: Year, Month, Avg_Temp (°C), Max_Temp (°C), ..., Solar_Irradiance (W/m²), ...
        climateRaw.forEach(d => {
          d.Year = Math.floor(+d.Year); // ensure integer year
          d.Solar = +d["Solar_Irradiance (W/m²)"];
        });
        // Filter climate data for US (should be all US-based)
        const climateUSA = climateRaw.filter(d => d.Country && d.Country.includes("United States") && !isNaN(d.Year) && !isNaN(d.Solar));
        // Group by Year: average Solar Irradiance.
        const climateByYear = d3.rollup(climateUSA, v => d3.mean(v, d => d.Solar), d => d.Year);
        climateDataGrouped = Array.from(climateByYear, ([Year, Solar]) => ({ Year, Solar }));
        climateDataGrouped.sort((a, b) => a.Year - b.Year);
        console.log("Grouped Climate Data:", climateDataGrouped);

        // --------------------------
        // Populate dropdown with available crops.
        // --------------------------
        const crops = Array.from(cropDataGrouped.keys()).sort();
        d3.select("#cropSelect")
          .selectAll("option")
          .data(crops)
          .enter()
          .append("option")
          .attr("value", d => d)
          .text(d => d);

        // Initially update chart with first crop.
        updateChart(crops[0]);

        // On dropdown change, update chart.
        d3.select("#cropSelect").on("change", function() {
          const selectedCrop = d3.select(this).property("value");
          updateChart(selectedCrop);
        });
        
      }).catch(error => {
        console.error("Error loading data:", error);
      });

    // --------------------------
    // Function to update the dual-axis chart.
    // --------------------------
    function updateChart(selectedCrop) {
      // Clear previous chart elements.
      svg.selectAll("*").remove();

      // Get crop production data for the selected crop.
      const cropData = cropDataGrouped.get(selectedCrop);
      // Merge with climate data by matching Year.
      const mergedData = cropData.map(d => {
        const climateEntry = climateDataGrouped.find(c => c.Year === d.Year);
        return {
          Year: d.Year,
          Production: d.Production,
          Solar: climateEntry ? climateEntry.Solar : null
        };
      }).filter(d => d.Solar !== null);
      console.log("Merged Data for", selectedCrop, ":", mergedData);

      // --------------------------
      // Set up scales.
      // --------------------------
      const xScale = d3.scaleLinear()
                       .domain(d3.extent(mergedData, d => d.Year))
                       .range([0, width]);

      // Left y-scale for Production.
      const yLeftScale = d3.scaleLinear()
                           .domain([0, d3.max(mergedData, d => d.Production) * 1.1])
                           .range([height, 0]);

      // Right y-scale for Solar Irradiance.
      const yRightScale = d3.scaleLinear()
                            .domain([0, d3.max(mergedData, d => d.Solar) * 1.1])
                            .range([height, 0]);

      // --------------------------
      // Draw Axes.
      // --------------------------
      // X-axis.
      svg.append("g")
         .attr("transform", `translate(0,${height})`)
         .call(d3.axisBottom(xScale).ticks(mergedData.length).tickFormat(d3.format("d")));

      // Left y-axis (Production).
      svg.append("g")
         .call(d3.axisLeft(yLeftScale))
         .append("text")
         .attr("transform", "rotate(-90)")
         .attr("y", -50)
         .attr("x", -height / 2)
         .attr("dy", "1em")
         .style("text-anchor", "middle")
         .text("Average Crop Yield (Production)");

      // Right y-axis (Solar Irradiance).
      svg.append("g")
         .attr("transform", `translate(${width},0)`)
         .call(d3.axisRight(yRightScale))
         .append("text")
         .attr("transform", "rotate(-90)")
         .attr("y", 40)
         .attr("x", -height / 2)
         .attr("dy", "1em")
         .style("text-anchor", "middle")
         .text("Avg Solar Irradiance (W/m²)");

      // --------------------------
      // Define Line Generators.
      // --------------------------
      const lineProduction = d3.line()
                               .x(d => xScale(d.Year))
                               .y(d => yLeftScale(d.Production));

      const lineSolar = d3.line()
                          .x(d => xScale(d.Year))
                          .y(d => yRightScale(d.Solar));

      // --------------------------
      // Draw Lines.
      // --------------------------
      // Crop production line (blue).
      svg.append("path")
         .datum(mergedData)
         .attr("fill", "none")
         .attr("stroke", "steelblue")
         .attr("stroke-width", 2)
         .attr("d", lineProduction);

      // Solar irradiance line (orange).
      svg.append("path")
         .datum(mergedData)
         .attr("fill", "none")
         .attr("stroke", "orange")
         .attr("stroke-width", 2)
         .attr("d", lineSolar);

      // --------------------------
      // Add Chart Title.
      // --------------------------
      svg.append("text")
         .attr("x", width / 2)
         .attr("y", -20)
         .attr("text-anchor", "middle")
         .style("font-size", "16px")
         .text(`US Crop Yield vs. Solar Irradiance for ${selectedCrop}`);

      // --------------------------
      // Add Data Point Circles with Tooltips.
      // --------------------------
      // Production data points.
      svg.selectAll(".dotProd")
         .data(mergedData)
         .enter()
         .append("circle")
         .attr("class", "dotProd")
         .attr("cx", d => xScale(d.Year))
         .attr("cy", d => yLeftScale(d.Production))
         .attr("r", 4)
         .attr("fill", "steelblue")
         .append("title")
         .text(d => `Year: ${d.Year}\nYield: ${d.Production.toFixed(2)}`);

      // Solar irradiance data points.
      svg.selectAll(".dotSolar")
         .data(mergedData)
         .enter()
         .append("circle")
         .attr("class", "dotSolar")
         .attr("cx", d => xScale(d.Year))
         .attr("cy", d => yRightScale(d.Solar))
         .attr("r", 4)
         .attr("fill", "orange")
         .append("title")
         .text(d => `Year: ${d.Year}\nSolar: ${d.Solar.toFixed(2)}`);
    }
  </script>
</body>
</html>
