<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>US Agricultural Analysis: CO₂ vs Crop Production</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* Previous CSS styles remain unchanged */
    body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; margin: 2rem; text-align: center; }
    h1 { color: #2c3e50; margin-bottom: 0.5rem; }
    #dataInfo { color: #7f8c8d; margin-bottom: 1.5rem; }
    #chart { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 0.8rem; border-radius: 4px; pointer-events: none; font-size: 0.9rem; opacity: 0; transition: opacity 0.2s; }
    .trendline { stroke: #e74c3c; stroke-width: 2; stroke-dasharray: 4 2; }
    .data-point:hover { stroke: #e67e22; stroke-width: 2px; }
    .zoom-controls { position: absolute; top: 100px; right: 20px; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h1>US Agricultural Analysis: CO₂ vs Crop Production</h1>
  <div id="dataInfo"></div>
  <div class="zoom-controls">
    <button onclick="resetZoom()">Reset Zoom</button>
  </div>
  <svg id="chart" width="1000" height="600"></svg>
  <div id="tooltip" class="tooltip"></div>
  <div id="loading">Loading agricultural data...</div>

  <script>
    // Corrected data URLs and column names
    const DATA_URLS = {
      crop: 'https://gist.githubusercontent.com/mystrycodes/3d3cf36c88a4f23a187cb4e12a835e10/raw/CropProduction.csv',
      co2: 'https://gist.githubusercontent.com/mystrycodes/f3e133db6c35f1f7180296e872441fe4/raw/Co2emmission.csv'
    };

    const margin = { top: 60, right: 80, bottom: 90, left: 100 };
    const width = 1000 - margin.left - margin.right;
    const height = 600 - margin.top - margin.bottom;
    
    const svg = d3.select('#chart')
      .append('g')
      .attr('transform', `translate(${margin.left}, ${margin.top})`);

    let xScale, yScale, zoomBehavior;
    let analysisData = [];

    Promise.all([d3.csv(DATA_URLS.crop), d3.csv(DATA_URLS.co2)])
      .then(processDatasets)
      .catch(handleLoadingError);

    function processDatasets([rawCrop, rawCO2]) {
      const cropData = cleanDataset(rawCrop, 'Production', 'Country');
      const co2Data = cleanDataset(rawCO2, 'Annual CO2 emissions', 'Entity');
      
      const commonYears = findCommonYears(cropData, co2Data);
      if (commonYears.length === 0) {
        showErrorMessage('No overlapping data available - check data sources');
        return;
      }

      analysisData = mergeDatasets(cropData, co2Data, commonYears);
      initializeVisualization();
      d3.select('#loading').remove();
    }

    // Updated cleanDataset function with proper column names
    function cleanDataset(data, valueField, countryField) {
      return data
        .filter(d => d[countryField] === 'United States')
        .map(d => ({
          year: +d.Year,
          value: +d[valueField].replace(/,/g, ''),
          country: d[countryField]
        }))
        .filter(d => !isNaN(d.year) && !isNaN(d.value));
    }

    function findCommonYears(crop, co2) {
      const cropYears = new Set(crop.map(d => d.year));
      return [...new Set(co2.map(d => d.year))]
        .filter(year => cropYears.has(year))
        .sort((a, b) => a - b);
    }

    function mergeDatasets(crop, co2, years) {
      return years.map(year => ({
        year,
        production: crop.find(d => d.year === year).value,
        co2: co2.find(d => d.year === year).value
      }));
    }

    // Rest of the visualization code remains the same
    function initializeVisualization() {
      xScale = d3.scaleLinear()
        .domain(d3.extent(analysisData, d => d.co2))
        .range([0, width])
        .nice();

      yScale = d3.scaleLinear()
        .domain(d3.extent(analysisData, d => d.production))
        .range([height, 0])
        .nice();

      zoomBehavior = d3.zoom()
        .scaleExtent([1, 8])
        .on('zoom', handleZoom);

      d3.select('#chart').call(zoomBehavior);
      drawBaseVisualization();
      addTrendline();
      addAxes();
    }

    function drawBaseVisualization() {
      svg.selectAll('.data-point')
        .data(analysisData)
        .enter()
        .append('circle')
        .attr('class', 'data-point')
        .attr('cx', d => xScale(d.co2))
        .attr('cy', d => yScale(d.production))
        .attr('r', 6)
        .attr('fill', '#3498db')
        .attr('stroke', '#fff')
        .attr('stroke-width', 1)
        .on('mouseover', showTooltip)
        .on('mouseout', hideTooltip);
    }

    function addAxes() {
      svg.append('g')
        .attr('class', 'x-axis')
        .attr('transform', `translate(0, ${height})`)
        .call(d3.axisBottom(xScale).tickFormat(d => `${d/1e6}M t`));

      svg.append('text')
        .attr('x', width/2)
        .attr('y', height + margin.bottom - 10)
        .style('text-anchor', 'middle')
        .text('CO₂ Emissions (Million Metric Tons)');

      svg.append('g')
        .attr('class', 'y-axis')
        .call(d3.axisLeft(yScale).tickFormat(d => `${d/1e3}k t`));

      svg.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('y', -margin.left + 20)
        .attr('x', -height/2)
        .style('text-anchor', 'middle')
        .text('Crop Production (Thousand Tons)');
    }

    function addTrendline() {
      const trend = d3.regressionLinear()
        .x(d => d.co2)
        .y(d => d.production)
        (analysisData);

      svg.append('path')
        .datum(trend)
        .attr('class', 'trendline')
        .attr('d', d3.line()([trend[0], trend[1]]));
    }

    function handleZoom(event) {
      const newX = event.transform.rescaleX(xScale);
      const newY = event.transform.rescaleY(yScale);

      svg.selectAll('.data-point')
        .attr('cx', d => newX(d.co2))
        .attr('cy', d => newY(d.production));

      svg.select('.x-axis').call(d3.axisBottom(newX));
      svg.select('.y-axis').call(d3.axisLeft(newY));
    }

    function resetZoom() {
      d3.select('#chart').transition()
        .duration(300)
        .call(zoomBehavior.transform, d3.zoomIdentity);
    }

    function showTooltip(event, d) {
      d3.select('#tooltip')
        .style('opacity', 1)
        .style('left', `${event.pageX + 15}px`)
        .style('top', `${event.pageY - 30}px`)
        .html(`
          <div>Year: ${d.year}</div>
          <div>CO₂: ${(d.co2/1e6).toFixed(1)}M tons</div>
          <div>Production: ${(d.production/1e3).toFixed(0)}k tons</div>
        `);
    }

    function hideTooltip() {
      d3.select('#tooltip').style('opacity', 0);
    }

    function handleLoadingError(error) {
      console.error('Data loading error:', error);
      d3.select('#loading')
        .html('<div class="error">⚠️ Error loading data. Please check your connection</div>');
    }

    function showErrorMessage(message) {
      d3.select('#loading').html(`<div class="error">⚠️ ${message}</div>`);
    }
  </script>
</body>
</html>
